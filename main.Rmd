---
title: "Wrangling"
author: "Shirley Cheung"
date: "April 25, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries
```{r, message = FALSE, warning = FALSE}
library(readr)
library(dplyr)
library(tidyr)
library(stringr)
library(fitdistrplus)
library(logspline)
```

## Wrangling
+ biocapcity data is 2016
+ regional data is 2013
+ greenhouse data is 2013

### Eco / Biocapacity Data
```{r, message = FALSE, warning = FALSE}
# Reading in eco dataset
ecoData <- read_csv("countries.csv") 
names(ecoData ) <- gsub(" ", "", names(ecoData )) 

# Cleaning up eco dataset
ecoData  <- ecoData  %>%
  rename("country" = "Country", 
         "region" = "Region",
         "population" = "Population(millions)",
         "totalFootprint" = "TotalEcologicalFootprint",
         "totalBiocap" = "TotalBiocapacity",
         "netFootprint" = "BiocapacityDeficitorReserve") %>%
  dplyr::select(country, region, population, GDPperCapita, 
                totalFootprint, totalBiocap, netFootprint) %>%
  mutate(GDPperCapita = 
           str_replace_all(GDPperCapita, c("[:punct:]" = "", "\\$" = "")))
```

### Regional Data
```{r}
# Reading in regional data
## Final regional dataset is total food production by country in 2013
regional <- read_csv("regional.csv") %>%
  replace_na(list(region = "NA")) %>%
  group_by(Area, Year) %>%
  mutate(totalProduction = sum(Production)) %>%
  filter(Year == 2013) %>%
  ungroup() %>%
  distinct(Area, .keep_all = TRUE) %>%
  dplyr::select('Area Abbreviation', Area, region, totalProduction)

# Finding countries in common that won't join because of spelling
spellingErrors <- anti_join(ecoData, regional, by = c("country" = "Area")) 

# Merging regional and eco data
ecoData <- ecoData %>%
  mutate(country = recode(country, 
                          "Antigua and Barbuda" = "Antigua",
                          "Brunei Darussalam" = "Brunei",
                          "Cabo Verde" = "Cape Verde",
                          "Congo" = "Democratic Republic of the Congo",
                          "Congo, Democratic Republic of" =
                            "Democratic Republic of the Congo",
                          "CÃ´te d'Ivoire" = "Ivory Coast",
                          "Equatorial Guinea" = "Guinea",
                          "Iran, Islamic Republic of" = "Iran",
                          "Korea, Democratic People's Republic of" =
                            "South Korea",
                          "Korea, Republic of" = "South Korea",
                          "Lao People's Democratic Republic" = "Laos",
                          "Macedonia TFYR" = "Macedonia",
                          "Russian Federation" = "Russia",
                          "Saint Kitts and Nevis" = "Saint Kitts",
                          "Saint Vincent and Grenadines" = "Saint Vincent",
                          "Syrian Arab Republic" = "Syria",
                          "Tanzania, United Republic of" = "Tanzania",
                          "Trinidad and Tobago" = "Trinidad",
                          "United Kingdom" = "UK",
                          "United States of America" = "USA",
                          "Venezuela, Bolivarian Republic of" = "Venezuela",
                          "Viet Nam" = "Vietnam")) %>%
  left_join(regional, by = c("country" = "Area")) %>%
  dplyr::select(-region.x) %>%
  rename("continent" = "region.y")
```

### Greenhouse Data
```{r}
# Reading in greenhouse gas dataset
greenhouse <- read_csv("greenhouseGas.csv") %>%
  dplyr::select(-category) %>%
  filter(year == 2013) %>%
  distinct(country_or_area, .keep_all = TRUE) # iceland was observed twice

# Finding countries in common that won't join because of spelling
spellingErrors <- anti_join(greenhouse, ecoData, 
                            by = c("country_or_area" = "country"))

# Fixing names
greenhouse <- greenhouse %>%
  mutate(country_or_area = recode(country_or_area, 
                                  "Russian Federation" = "Russia",
                                  "United Kingdom" = "UK",
                                  "United States of America" = "USA"))

# Merging greenhouse gas dataset with eco dataset
ecoData <- ecoData %>%
  left_join(greenhouse, by = c("country" = "country_or_area"))
```

### HDI Data
```{r}
HDI <- read_csv("HDI.csv") %>% 
  dplyr::select(Country, `2015`) %>%
  mutate(Country = recode(Country,
         "Antigua and Barbuda" = "Antigua", 
         "Bolivia (Plurinational State of)" = "Bolivia",
         "Brunei Darussalam" = "Brunei", 
         "Cabo Verde" = "Cape Verde",
         "Iran (Islamic Republic of)" = "Iran",
         "Lao People's Democratic Republic" = "Laos",
         "Libya" = "Libyan Arab Jamahiriya",
         "Russian Federation" = "Russia",
         "Saint Kitts and Nevis" = "Saint Kitts", 
         "Saint Vincent and the Grenadines" = "Saint Vincent", 
         "Viet Nam" = "Vietnam",
         "United Kingdom" = "UK",
         "United States" = "USA",
         "Venezuela (Bolivarian Republic of)" = "Venezuela",
         "Trinidad and Tobago" = "Trinidad",
         "Tanzania (United Republic of)" = "Tanzania",
         "Congo (Democratic Republic of the)" = "Democratic Republic of the Congo")
  )
  
HDI$Country[HDI$`2015` == 0.474] <- "Ivory Coast"

# Finding countries in common that won't join because of spelling
spellingErrors2 <- anti_join(ecoData, HDI, 
                            by = c("country" = "Country"))
ecoData <- ecoData %>%
  left_join(HDI, by = c("country" = "Country")) %>% 
  dplyr::select(-year, -value, -`Area Abbreviation`) %>%
  drop_na() %>%
  mutate(region = unclass(as.factor(continent)))

#convert categorical into numeric
write_csv(ecoData, "ecoData.csv")

```

## Fitting Distribution
```{r}
# Determining distribution of Y
# Our Y-variable = net biocapcity of each country
hist(ecoData$netBiocap)
descdist(ecoData$netBiocap, discrete = FALSE)

# Looks like a beta distribution 
# Solve for parameters, alpha and beta, from the summary mu and sd
# Recall for the beta distribution
## mu = alpha / (alpha + beta)
## var = alpha*beta / [(alpha + beta)^2 (alpha + beta + 1)]
parameters <- function(mu, var) {
  alpha <- ((1 - mu)/var - 1/mu) * mu^2
  beta <- alpha * (1/mu - 1)
  return(params = list(alpha = alpha, beta = beta))
}
parameters(0.7020745, 11.77134^2)

# Problem: we have negative values for alpha, beta
# Also have negative values for our y's. Support of beta distribution
# should only be in (0,1). Need to do a transformation? Or not beta
# distribution. 

# fitBeta <- fitdist(countries$netBiocap, "beta")
# plot(fitBeta)

# Y = total biocapcity
hist(ecoData$totalBiocap)
descdist(ecoData$totalBiocap, discrete = FALSE)

# Y = total footprint
hist(ecoData$totalFootprint)
descdist(ecoData$totalFootprint, discrete = FALSE)
```

## Visualizations
```{r}
# Can you recycle code from project 3 and make another chloropleth map
# of the entire world where countries are filled in with their net 
# bio capacity? can test continuous case and then also categorical case where 
# we color by whether it's deficit or reserve

```


