---
title: "Net Ecological Footprint of Countries in the World"
author: "Shirley Cheung and Tuan Nguyen"
date: "April 30, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction
A third of all food produced for human consumption --- 1.3 billions tons --- is wasted every year. This amounts to an annual global loss of \$990 billion, of which the United States alone contributes \$165 billion ([FAO](http://www.fao.org/save-food/resources/keyfindings/en/)). This is a devastating waste of resources: from the food itself to the labor, time, and additional capital required to produce this food (ie. water). In a world where there still exist countries that suffer from hunger and global population which grows exponentially, we simply can't afford to misuse our resources in this imprudent manner. 

To estimate the entirety of wasted resources and not just food alone, we can use two existing metrics: ecological footprint and biocapacity. Intuitively, ecological footprint is the "amount of nature" required to sustain a given population. This figure might include the amount of land needed to absorb carbon dioxide emissions or the amount of land necessary to grow enough food to feed a population. Biocapacity is the "amount of nature" actually available for consumption needs. For instance, the biocapacity of land accessible for food production might 1000 hectares in one country, but only 500 hectares in another. A familiar analogy of biocapacity and ecological footprint is supply and demand (respectively), where we're now simply dealing in units of biologically productive land. A country runs an ecological deficit when its footprint exceeds its biocapacity and an ecological surplus when its biocapcity exceeds its footprint. Henceforth, we will simply refer to the ecological deficit/surplus of a nation as its net footprint. 

In this project, we explore, on a country level, the relationship between net footprint and the following variables: 

* Population
* GDP per capita
* Total food production
* Greenhouse gas emission
* Human Development Index
* Continent 

Data on net footprint, population, GDP per capita, and continent was collected from the Global Footprint Network and downloaded from [Kaggle](https://www.kaggle.com/footprintnetwork/ecological-footprint). These variables were recorded for the year 2016. The variable of total food production was created using data from the Food and Agriculture Organization of the United Nations (FAO) and also downloaded from [Kaggle](https://www.kaggle.com/unitednations/global-food-agriculture-statistics/data). Unfortunately, data for 2016 was not available; thus, we used the most recent data of 2013. The variable of greenhouse gas emission was collected from the [World Resources Institute](http://www.wri.org/resources/data-sets/cait-country-greenhouse-gas-emissions-data). Similar to the food production data, the year 2016 was not available and thus we used the most recent year of 2012. Finally, data on the 2015 Human Development Index was collected from the [United Nations Development Programme](http://hdr.undp.org/en/data#). The Human Development Index essentially measures the cultural and social "strength" of a population such as the average life span, level of education, and standard of life. To summarise, 

Variable                  | Type  |  Year  | Source
------------------------- | ----- | ------ | ----------
Net Footprint             |  $y$  |  2016  | [Global Footprint Network](https://www.kaggle.com/footprintnetwork/ecological-footprint)
Population                |  $x$  |  2016  | [Global Footprint Network](https://www.kaggle.com/footprintnetwork/ecological-footprint)
GDP per capita            |  $x$  |  2016  | [Global Footprint Network](https://www.kaggle.com/footprintnetwork/ecological-footprint)
Continent                 |  $x$  |  2016  | [Global Footprint Network](https://www.kaggle.com/footprintnetwork/ecological-footprint)
Total food production     |  $x$  |  2013  | [Food and Agriculture Organization](https://www.kaggle.com/unitednations/global-food-agriculture-statistics/data)
Greenhouse gas emission   |  $x$  |  2012  | [World Resources Institute](http://www.wri.org/resources/data-sets/cait-country-greenhouse-gas-emissions-data)
Human development index   |  $x$  |  2015  | [United Nations Development Programme](http://hdr.undp.org/en/data#)

# Wrangling
```{r, message = FALSE, warning = FALSE, echo = FALSE}
library(readr)
library(ggmap)
library(ggplot2)
library(ggthemes)
library(maps)
library(dplyr)
library(tidyr)
library(lme4)

ecoData <- read_csv("ecoData.csv")
ecoDataReg <- read_csv("ecoDataReg.csv")
```

To merge these five different predictors into one dataset, we performed left-joins on the Country field. The majority of our wrangling efforts was spent on anti-joining the master dataset and the smaller one containing the predictor to reconcile different names of the same country (e.g USA vs United States of America).

### World Data
```{r}
world <- map_data("world") %>%
  dplyr::select(-subregion)

# Finding countries in common that won't join because of spelling
spellingErrors <- anti_join(ecoData, world, by = c("country" = "region"))

# Fixing world names
world <- world %>%
  mutate(region = recode(region, 
                         "Antigua" = "Antigua and Barbuda",
                         "Barbuda" = "Antigua and Barbuda",
                         "Virgin Islands" = "British Virgin Islands",
                         "Brunei" = "Brunei Darussalam",
                         "Saint Kitts" = "Saint Kitts and Nevis",
                         "Saint Vincent" = "Saint Vincent and Grenadines",
                         "Trinidad" = "Trinidad and Tobago",
                         "Tobago" = "Trinidad and Tobago",
                         "UK" = "United Kingdom",
                         "USA" = "United States of America",
                         "Wallis and Futuna" = "Wallis and Futuna Islands"))

# Fixing eco names
ecoData <- ecoData %>%
  mutate(country = recode(country,
                          "Cabo Verde" = "Cape Verde",
                          "Congo" = "Republic of Congo",
                          "Congo, Democratic Republic of" = 
                            "Democratic Republic of the Congo",
                          "Côte d'Ivoire" = "Ivory Coast",
                          "Iran, Islamic Republic of" = "Iran",
                          "Korea, Democratic People's Republic of" =
                            "South Korea",
                          "Korea, Republic of" = "North Korea",
                          "Lao People's Democratic Republic" = "Laos",
                          "Libyan Arab Jamahiriya" = "Libya",
                          "Macedonia TFYR" = "Macedonia",
                          "Réunion" = "Reunion",
                          "Russian Federation" = "Russia",
                          "Syrian Arab Republic" = "Russia",
                          "Tanzania, United Republic of" = "Tanzania",
                          "Venezuela, Bolivarian Republic of" =
                            "Venezuela",
                          "Viet Nam" = "Vietnam"))

# Merging eco and world data
ecoData <- ecoData %>%
  left_join(world, by = c("country" = "region")) %>%
  dplyr::select(-region)
```

### Production Data
```{r}
# Reading in regional data
production <- read_csv("production.csv") %>%
  replace_na(list(region = "NA")) %>%
  group_by(Area, Year) %>%
  mutate(totalProduction = as.numeric(sum(Production))) %>%
  filter(Year == 2013) %>%
  ungroup() %>%
  distinct(Area, .keep_all = TRUE) %>%
  dplyr::select(region, Area, totalProduction) %>%
  rename("continent" = "region", "country" = "Area")

# Finding countries in common with eco Data that won't join because of spelling
spellingErrors <- anti_join(production, ecoData, by = "country")

# Fixing names and merging with production data
## Some countries are missing in eco data so there's nothing we can do about
## missing observations

## Combining China's total production
china <- production %>%
  filter(country %in% c("China, Hong Kong SAR", 
                        "China, Macao SAR",
                        "China, mainland")) %>%
  mutate(country = recode(country, 
                          "China, Hong Kong SAR" = "China",
                          "China, Macao SAR" = "China",
                          "China, mainland" = "China")) %>%
  group_by(continent, country) %>%
  summarise(totalProduction = sum(totalProduction))

## Updating production data
production <- production %>%
  filter(!(country %in% c("China, Hong Kong SAR", 
                        "China, Macao SAR",
                        "China, mainland"))) %>%
  full_join(china)

# Fixing names in production data
production <- production %>%
  mutate(country = recode(country,
                          "Bolivia (Plurinational State of)" = "Bolivia",
                          "Cabo Verde" = "Cape Verde",
                          "Congo" = "Republic of Congo",
                          "Czechia" = "Czech Republic",
                          "Democratic People's Republic of Korea" =
                            "South Korea",
                          "Iran (Islamic Republic of)" = "Iran",
                          "Lao People's Democratic Republic" = "Laos",
                          "Republic of Korea" = "North Korea",
                          "Republic of Moldova" = "Moldova",
                          "Saint Vincent and the Grenadines" =
                            "Saint Vincent and Grenadines",
                          "Russian Federation" = "Russia",
                          "The former Yugoslav Republic of Macedonia" =
                            "Macedonia",
                          "United Republic of Tanzania" = "Tanzania",
                          "Venezuela (Bolivarian Republic of)" = 
                            "Venezuela",
                          "Viet Nam" = "Vietnam"))

# Merging eco and production data 
ecoData <- ecoData %>%
  left_join(production, by = "country")
```

### Greenhouse Data
```{r}
# Reading in greenhouse gas dataset
greenhouse <- read_csv("CAITGHGData.csv") %>%
  filter(Year == 2012) %>%
  rename("totalGHG" = `Total GHG Emissions Including Land-Use Change and Forestry (MtCO?e?)`) %>%
  dplyr::select(Country, totalGHG)
  
# Finding countries in common that won't join because of spelling
spellingErrors <- anti_join(greenhouse, ecoData, by = c("Country" = "country"))

# Fixing names and merging with production data
## Some countries are missing in eco data so there's nothing we can do about
## missing observations
greenhouse <- greenhouse %>%
  mutate(Country = recode(Country,
                          "Antigua & Barbuda" = "Antigua and Barbuda",
                          "Bahamas, The" = "Bahamas",
                          "Bosnia & Herzegovina" = "Bosnia and Herzegovina",
                          "Brunei" = "Brunei Darussalam",
                          "Congo, Dem. Rep." = 
                            "Democratic Republic of the Congo",
                          "Congo, Rep." = "Republic of Congo",
                          "Cote d'Ivoire" = "Ivory Coast",
                          "Korea, Rep. (South)" = "South Korea",
                          "Korea, Dem. Rep. (North)" = "North Korea",
                          "Macedonia, FYR" = "Macedonia",
                          "Russian Federation" = "Russia",
                          "Saint Kitts & Nevis" = "Saint Kitts and Nevis",
                          "Saint Vincent & Grenadines" = 
                            "Saint Vincent and Grenadines",
                          "Trinidad & Tobago" = "Trinidad and Tobago",
                          "United States" = "United States of America",
                          "United States of America" = "USA"))

# Merging greenhouse gas dataset with eco dataset
ecoData <- ecoData %>%
  left_join(greenhouse, by = c("country" = "Country"))
```

### HDI Data
```{r}
# Reading in HDI data
HDI <- read_csv("HDI.csv") %>%
  rename("country" = "Country",
         "HDI2015" = `2015`) %>%
  dplyr::select(country, HDI2015)

# Finding countries in common that won't join because of spelling
spellingErrors <- anti_join(HDI, ecoData, by = "country")

# Fixing spelling errors
HDI <- HDI %>%
  mutate(country = recode(country,
         "Bolivia (Plurinational State of)" = "Bolivia",
         "Cabo Verde" = "Cape Verde",
         "Congo" = "Republic of Congo",
         "Congo (Democratic Republic of the)" = 
           "Democratic Republic of the Congo",
         "C<99>te d'Ivoire" = "Ivory Coast",
         "Iran (Islamic Republic of)" = "Iran", 
         "Korea (Republic of)" = "North Korea",
         "Lao People's Democratic Republic" = "Laos",
         "Moldova (Republic of)" = "Moldova",
         "Russian Federation" = "Russia",
         "Saint Vincent and the Grenadines" = 
           "Saint Vincent and Grenadines", 
         "Tanzania (United Republic of)" = "Tanzania",
         "The former Yugoslav Republic of Macedonia" = "Macedonia",
         "United States" = "United States of America",
         "Venezuela (Bolivarian Republic of)" = "Venezuela",
         "Viet Nam" = "Vietnam"))
HDI$country[HDI$HDI2015 == 0.474] <- "Ivory Coast"

# Merging with HDI data
ecoData <- ecoData %>%
  left_join(HDI, by = "country") %>%
  drop_na() %>%
  mutate(binomFootprint = as.factor(ifelse(netFootprint < 0, 0, 1))) %>%
  mutate(transFootprint = log(netFootprint + 15))

# eco data without world map data contained
## This form of data is better for building our models
ecoDataReg <- ecoData %>%
  distinct(country, .keep_all = TRUE) %>%
  dplyr::select(-lat, -long, -group, -order)

# Saving our final eco datasets
write_csv(ecoData, "ecoData.csv")
write_csv(ecoDataReg, "ecoDataReg.csv")
netFootprint <- ecoDataReg$netFootprint
transFootprint <- ecoDataReg$transFootprint
binomFootprint <- ecoDataReg$binomFootprint
population <- ecoDataReg$population
totalProduction <- ecoDataReg$totalProduction 
GDPperCapita <- ecoDataReg$GDPperCapita 
totalGHG <- ecoDataReg$totalGHG 
HDI2015 <- ecoDataReg$HDI2015 
 
glimpse(ecoDataReg)
```

# Model Assumptions
Before we can build our regression model, it's crucial that we first check that we haven't violated assumptions. First, let's take a look at our $y$ variable:

```{r}
# Frequency of Net Footprint 
hist(netFootprint, main = "Histogram of Net Footprint", xlab = "Net Footprint")
summary(netFootprint)
```
We see that our $y$ variable of net footprint doesn't seem to follow a normal distribution. It's skewed to the right. What we can do to fix this is to take a transformation of our $y$. Let $$\text{transFootprint} = \text{log}(\text{netFootprint} + 15)$$

```{r}
# Frequency of Transformed Net Footprint
hist(transFootprint, main = "Histogram of Transformed Net Footprint",
     xlab = "Transformed Net Footprint")
```
Now let's check if our $x_{ij}$'s and transformed $y_{i}$ are linearly related.

```{r}
# Untransformed X
plot(population, transFootprint, 
     main = "Population vs. Transformed Net Footprint",
     xlab = "Population", ylab = "Transformed Net Footprint")

# Transformed X
plot(log(population), transFootprint,
     main = "Transformed Population vs. Transformed Net Footprint",
     xlab = "log(Population)", ylab = "Transformed Net Footprint")
```
After checking for linear relationships between all of our $x_{ij}$s and transformed $y$, we end up with $$\text{log}(y_{i} + 15) = \beta_{0} + \beta_{1}log(x_{i1}) + \beta_{2}log(x_{i2}) + \beta_{3}log(x_{i3}) + \beta_{4}log(x_{i4}) + \beta_{5}log(x_{i5})$$ where $x_1$ denotes population, $x_2$ denotes GDP per capita, $x_3$ denotes total food production, $x_4$ denotes greenhouse gas emission, and $x_5$ denotes the human development index. It is important to note that while we have a linear relationship between our transformed $x$'s and $y$, the relationship between our original $x$'s and $y$ is multiplicative.

Now let's check our residual and QQ plots for this model.
```{r}
# Regression 
fit1 <- lm(transFootprint ~ log(population) + log(totalProduction) +
             log(GDPperCapita) + log(totalGHG) + log(HDI2015), 
           data = ecoDataReg)

# Residual and QQ Plots
plot(fit1, which = c(1,2))
```

# Hierarchical Models
Hierarchical models are in fact quite intuitive. For example, if you have data on students in classrooms and schools, you have a two-level hierarchy: classrooms within schools. If you also have data on school districts, then you have a three-level hierarchy: classrooms within schools within school districts. In this case, we have have a two-level hierarchy: countries and continents. We want to estimate how our net footprint varies by country and continent. To fit hierarchical models in R, the lme4 package is your best bet.

### Normal Hierarchical Model
Our first hierarchical model is a normal hierarchical model. It uses transFootprint as our $y$ variable, which we've assumed to be normally distributed after checking our model assumptions in the prior section. The regression tested below is almost identical to the one we derived above. The only difference is the added level of continent. Writing continent as (1|continent) tells R that we wish to add continent to our model as a random effect, rather than a fixed one.

```{r}
normalModel <- lmer(transFootprint ~ (1|continent) + 
                       log(population) + 
                       log(totalProduction) +
                       log(GDPperCapita) + 
                       log(totalGHG) + log(HDI2015), 
                     data = ecoDataReg)

summary(normalModel)
```
In the summary output of our normal hierarchical model, we see that the variance of continent is 0.04471, which is quite small. This suggests that adding continent to our model not as helpful as we would have hoped. In addition, all of our predictors, except for GDP, are insignificant. GDP seems to have a negative correlation with net footprint. One hypothesis as to why this may be true is that richer countries may import more goods from other countries and therefore be less taxing their own natural resources.

### Binomial Hierarchical Model
Our second hierarchial model is a binomial hierarchical model. In this case, we've mutated our original $y$ variable of net footprint into binomFootprint, which consists of 1's and 0's -- 1 if the country has an ecologicial surplus and 0 if the country has a ecological deficit. binomFootprint is a categorical variable with a binomial distribution.

```{r}
binomialModel <- glmer(binomFootprint ~ (1|continent) + 
                       population + 
                       totalProduction +
                       GDPperCapita + 
                       totalProduction + 
                       totalGHG + HDI2015, 
                     data = ecoDataReg)

summary(binomialModel)
```
Our binomial hierarchical model largely agrees with our normal hierarchical model, though its exact numbers differ. We see that continent has a variance of 0.0745, which is quite small. This, again, suggests that adding continent to our model is not the most useful. In our predictors, the only significant variable seems to be GDP, which agree with our first model.

# Visualizations
To visualize the random effect of continent, we produced two chloropleth maps of the world, where countries are filled in by net footprint. In the first chloropleth, we've filled in countries on a continuous scale, which is the case when our $y$ is the transformed net footprint.

```{r}
ggplot() + 
  geom_polygon(data = ecoData, 
               aes(x = long, y = lat, fill = transFootprint, group = group),
               col = "white") +
  scale_fill_continuous(low = "thistle2", high = "darkred", 
                        guide = "colorbar", na.value = "white", 
                        name = "Net Ecological Footprint") +
  theme_minimal()
```
In the second chloropleth, we've filled in countries on a discrete scale, which is the case when our $y$ is the categorical indicator of either ecological deficit or surplus.

```{r}
ggplot() + 
  geom_polygon(data = ecoData, 
               aes(x = long, y = lat, fill = as.factor(binomFootprint), 
                   group = group),
               col = "white") +
  scale_fill_brewer(palette = "Set2", name = "Net Ecological Footprint", 
                    labels = c("Deficit", "Reserve")) +
  theme_minimal()
```

# Conclusion
try other predictors 
hierarchical model not necessary
